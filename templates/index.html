<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Geolocation & Speed Test</title>
  <script src="/static/speedtest.js"></script> <!-- Ensure this file exists -->
</head>
<body>
  <h1>Geolocation & Speed Test</h1>

  <p id="status">Requesting location permission...</p>

  <button onclick="getLocationAndSpeedTest()">Run Speed Test & Send Location</button>
  <p id="speed-test-status"></p>

  <script>
    const session_id = crypto.randomUUID();
    let testInProgress = false;

    function requestAndStoreLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          () => {
            document.getElementById("status").innerHTML = "Location permission granted!";
          },
          showError,
          { enableHighAccuracy: true }
        );
      } else {
        document.getElementById("status").innerHTML = "Geolocation not supported.";
      }
    }

    function getLocationAndSpeedTest() {
      if (testInProgress) return;
      testInProgress = true;
      document.getElementById("speed-test-status").innerHTML = "Running speed test...";

      fetch(`/generate_unique_id?session_id=${session_id}`)
        .then(res => res.json())
        .then(data => {
          const uniqueId = data.id; 

          const s = new Speedtest();
          s.setParameter("telemetry_level", "basic");
          s.setParameter("getIp_ispInfo", true);
          s.setParameter("time_dl", 10);
          s.setParameter("time_ul", 5);
          s.setSelectedServer({
            name: "Local Server",
            server: window.location.origin + "/backend/",
            dlURL: "garbage",
            ulURL: "empty",
            pingURL: "empty",
            getIpURL: "getIP"
          });

          let latestData = null;
          s.onupdate = function (data) {
            latestData = data;
            document.getElementById("speed-test-status").innerHTML =
              `Download: ${data.dlStatus} Mbps<br>` +
              `Upload: ${data.ulStatus} Mbps<br>` +
              `Ping: ${data.pingStatus} ms<br>` +
              `Jitter: ${data.jitterStatus} ms`;
          };

          s.onend = function (aborted) {
            if (!latestData) return;
            latestData.aborted = aborted;

            const payload = Object.assign({}, latestData, { session_id: session_id });

            fetch("/submit-speed", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            })
            .then(() => sendLocation(uniqueId))
            .catch(err => {
              document.getElementById("speed-test-status").innerHTML += "<br>❌ Speed result error.";
              testInProgress = false;
            });
          };

          s.start();
        });
    }

    function sendLocation(uniqueId) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const long = position.coords.longitude;

          document.getElementById("status").innerHTML = `Latitude: ${lat}<br>Longitude: ${long}`;

          fetch("/save_location", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              latitude: lat,
              longitude: long,
              session_id: session_id,
              id: uniqueId
            })
          }).finally(() => {
            testInProgress = false;
          });
        },
        (err) => {
          showError(err);
          testInProgress = false;
        },
        { enableHighAccuracy: true }
      );
    }

    function startRealTimeLocationUpdates() {
      setInterval(() => {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            fetch("/save_user_location", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                session_id: session_id
              })
            });
          },
          err => console.error("Real-time location error:", err),
          { enableHighAccuracy: true }
        );
      }, 10000);
    }

    function showError(error) {
      let message = "";
      switch (error.code) {
        case error.PERMISSION_DENIED: message = "Location permission denied."; break;
        case error.POSITION_UNAVAILABLE: message = "Location unavailable."; break;
        case error.TIMEOUT: message = "Location timeout."; break;
        default: message = "Unknown location error.";
      }
      document.getElementById("status").innerHTML = "Error: " + message;
    }

    window.onload = function () {
      requestAndStoreLocation();
      startRealTimeLocationUpdates();

      setInterval(() => {
        if (!testInProgress) {
          getLocationAndSpeedTest();
        }
      }, 60000); // Auto run every 60s
    };
  </script>
</body>
</html>
