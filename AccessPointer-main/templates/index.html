
<!DOCTYPE html>
<html>
<head>
  <title>Geolocation & Speed Test</title>
  <script>
  // Set the worker file path for speedtest.js
  const SpeedtestWorkerPath = "/static/speedtest_worker.js?ts=" + new Date().getTime();
  console.log("SpeedtestWorkerPath:", SpeedtestWorkerPath);
  </script>
  <script src="/static/speedtest.js"></script>
  <script>
    const session_id = crypto.randomUUID();
    let uniqueId = null;
    let speedTest;

    function requestAndStoreLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          () => {
            document.getElementById("status").innerHTML = "Location permission granted!";
          },
          showError,
          { enableHighAccuracy: true }
        );
      } else {
        document.getElementById("status").innerHTML = "Geolocation is not supported by this browser.";
      }
    }

    function startClientSideSpeedTestWithLocation() {
      if (!navigator.geolocation) {
        document.getElementById("status").innerHTML = "Geolocation is not supported by this browser.";
        return;
      }

      // Disable the button during the test
      const btn = document.getElementById("speedTestBtn");
      console.log("Disabling button...");
      btn.disabled = true;

      // Get the user's location
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const latitude = position.coords.latitude;
          const longitude = position.coords.longitude;

          // Display location
          document.getElementById("status").innerHTML = `
            Latitude: ${latitude}<br>
            Longitude: ${longitude}
          `;

          // Initialize the speed test
          speedTest = new Speedtest({ workerFile: SpeedtestWorkerPath });

          // Display status
          document.getElementById("speed-test-status").innerHTML = "Running speed test...";

          // Run the speed test
          speedTest.onupdate = function (data) {
            console.log("Speed test update:", data);
            document.getElementById("speed-test-status").innerHTML = `
              Download Speed: ${data.dlStatus} Mbps<br>
              Upload Speed: ${data.ulStatus} Mbps<br>
              Ping: ${data.pingStatus} ms
            `;
          };

          speedTest.onend = function (data) {
            console.log("Speed test complete:", data);
            document.getElementById("speed-test-status").innerHTML = `
              <strong>Speed Test Complete:</strong><br>
              Download Speed: ${data.dlStatus} Mbps<br>
              Upload Speed: ${data.ulStatus} Mbps<br>
              Ping: ${data.pingStatus} ms
            `;

            // Send speed test results and location to the server
            fetch("/save_speed_test_results", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                download: data.dlStatus,
                upload: data.ulStatus,
                ping: data.pingStatus,
                latitude: latitude,
                longitude: longitude,
                session_id: session_id
              })
            }).then(() => {
              btn.disabled = false; // Re-enable the button
            }).catch(() => {
              btn.disabled = false; // Re-enable the button even if there's an error
            });
          };

          console.log("Initializing speedtest...");
          speedTest.start();
          console.log("Speedtest initialized.", speedTest);
        },
        (error) => {
          showError(error);
          btn.disabled = false; // Re-enable the button if location fails
        },
        { enableHighAccuracy: true }
      );
    }

    // function getLocationAndSpeedTest() {
    //   const btn = document.getElementById("speedTestBtn");
    //   btn.disabled = true;

    //   document.getElementById("speed-test-status").innerHTML = "Running speed test...";

    //   fetch(`/generate_unique_id?session_id=${session_id}`)
    //     .then(response => response.json())
    //     .then(data => {
    //       uniqueId = data.id;

    //       fetch(`/speed_test?session_id=${session_id}`)
    //         .then(response => response.json())
    //         .then(testData => {
    //           if (testData.error) {
    //             document.getElementById("speed-test-status").innerHTML = testData.error;
    //             btn.disabled = false;
    //             return;
    //           }

    //           document.getElementById("speed-test-status").innerHTML =
    //             "Download Speed: " + testData.download_speed + "<br>" +
    //             "Upload Speed: " + testData.upload_speed + "<br>" +
    //             "Ping: " + testData.ping;

    //           navigator.geolocation.getCurrentPosition(
    //             (position) => {
    //               const lat = position.coords.latitude;
    //               const long = position.coords.longitude;

    //               document.getElementById("status").innerHTML =
    //                 "Latitude: " + lat + "<br>Longitude: " + long;

    //               fetch("/save_location", {
    //                 method: "POST",
    //                 headers: { "Content-Type": "application/json" },
    //                 body: JSON.stringify({
    //                   latitude: lat,
    //                   longitude: long,
    //                   session_id: session_id
    //                 })
    //               })
    //               .then(() => btn.disabled = false)
    //               .catch(() => btn.disabled = false);
    //             },
    //             () => btn.disabled = false,
    //             { enableHighAccuracy: true }
    //           );
    //         })
    //         .catch(() => btn.disabled = false);
    //     });
    // }

    function startRealTimeLocationUpdates() {
      if (navigator.geolocation) {
        setInterval(() => {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const latitude = position.coords.latitude;
              const longitude = position.coords.longitude;

              fetch("/save_user_location", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  latitude: latitude,
                  longitude: longitude,
                  session_id: session_id
                })
              });
            },
            (error) => {
              console.error("Real-time location error:", error);
            },
            { enableHighAccuracy: true }
          );
        }, 10000);
      } else {
        console.error("Geolocation not supported.");
      }
    }

    function startBackgroundSpeedTest() {
      setInterval(() => {
        fetch(`/check_speed_test_status?session_id=${session_id}`)
          .then(response => response.json())
          .then(data => {
            if (!data.in_progress) {
              startClientSideSpeedTestWithLocation();
            } else {
              console.log("Background speed test skipped (already in progress)");
            }
          });
      }, 60000);
    }

    function refreshHeatmap() {
      const heatmap = document.getElementById("heatmap-img");
      heatmap.src = `/static/heatmap.png?ts=${new Date().getTime()}`;
    }

    function showError(error) {
      let message = "";
      switch (error.code) {
        case error.PERMISSION_DENIED:
          message = "User denied the request for Geolocation.";
          break;
        case error.POSITION_UNAVAILABLE:
          message = "Location information is unavailable.";
          break;
        case error.TIMEOUT:
          message = "The request to get user location timed out.";
          break;
        default:
          message = "An unknown error occurred.";
      }
      document.getElementById("status").innerHTML = "Error: " + message;
    }

    window.onload = function () {
      requestAndStoreLocation();
      startRealTimeLocationUpdates();
      startBackgroundSpeedTest();
      setInterval(refreshHeatmap, 5000); // ‚è± Refresh heatmap every 5 seconds
    };
  </script>
</head>
<body>
  <h1>Geolocation & Speed Test</h1>

  <p id="status">Requesting location permission...</p>

  <button id="speedTestBtn" onclick="startClientSideSpeedTestWithLocation()">Run Speed Test & Send Location</button>
  <p id="speed-test-status"></p>

  <h2>Live WiFi Heatmap</h2>
  <img id="heatmap-img" src="/static/heatmap.png" alt="Heatmap" style="max-width: 100%;">
</body>
</html>
